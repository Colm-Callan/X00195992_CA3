# Minimal pipeline: Build + Test + Coverage + Artifact
# Triggers on pushes and PRs to main & dev

trigger:
  branches:
    include:
      - main
      - dev

pr:
  branches:
    include:
      - main
      - dev

pool:
  vmImage: 'ubuntu-latest'

variables:
  javaVersion: '21'

stages:
- stage: Build
  displayName: 'Build & Test & Coverage'
  jobs:
  - job: BuildJob
    displayName: 'Gradle build/test/coverage'
    steps:
    - task: JavaToolInstaller@0
      displayName: 'Use Java 21'
      inputs:
        versionSpec: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'

    - task: Gradle@3
      displayName: 'Gradle: clean test coverage shadowJar'
      inputs:
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx1024m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: |
          **/build/test-results/test/*.xml
          **/build/test-results/cucumber.xml
        tasks: 'clean :app:test :app:jacocoTestReport :app:jacocoTestCoverageVerification :app:shadowJar'

    - task: PublishCodeCoverageResults@1
      displayName: 'Publish JaCoCo coverage'
      inputs:
        codeCoverageTool: 'JaCoCo'
        summaryFileLocation: 'app/build/reports/jacoco/test/jacocoTestReport.xml'
        reportDirectory: 'app/build/reports/jacoco/test'
        failIfCoverageEmpty: true

    - task: CopyFiles@2
      displayName: 'Copy build outputs'
      inputs:
        contents: |
          app/build/libs/*all.jar
          app/build/reports/jacoco/test/jacocoTestReport.xml
          app/build/test-results/test/*.xml
          app/build/test-results/cucumber.xml
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish build-outputs artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'build-outputs'