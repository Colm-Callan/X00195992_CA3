trigger:
  branches:
    include:
      - main
      - dev

pr:
  branches:
    include:
      - main
      - dev

pool:
  vmImage: 'ubuntu-latest'

variables:
  javaVersion: '21'
  azureSubscription: 'AzureRM-x00195992'
  webAppTest: 'app-x00195992-ca3-test'

stages:
- stage: Build
  displayName: 'Build & Test & Coverage'
  jobs:
  - job: BuildJob
    displayName: 'Gradle build/test/coverage'
    steps:
    - task: JavaToolInstaller@0
      displayName: 'Use Java 21'
      inputs:
        versionSpec: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'

    - task: Gradle@3
      displayName: 'Gradle: clean test coverage shadowJar'
      inputs:
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx1024m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: |
          **/build/test-results/test/*.xml
          **/build/test-results/cucumber.xml
        tasks: 'clean :app:test :app:jacocoTestReport :app:jacocoTestCoverageVerification :app:shadowJar'

    - task: PublishCodeCoverageResults@1
      displayName: 'Publish JaCoCo coverage'
      inputs:
        codeCoverageTool: 'JaCoCo'
        summaryFileLocation: 'app/build/reports/jacoco/test/jacocoTestReport.xml'
        reportDirectory: 'app/build/reports/jacoco/test'
        failIfCoverageEmpty: true

    - task: CopyFiles@2
      displayName: 'Stage build outputs (jar, coverage, test XML, classes)'
      inputs:
        contents: |
          app/build/libs/*all.jar
          app/build/reports/jacoco/test/jacocoTestReport.xml
          app/build/test-results/test/*.xml
          app/build/test-results/cucumber.xml
          app/build/classes/java/main/**
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: CopyFiles@2
      displayName: 'Copy startup script into artifact'
      inputs:
        sourceFolder: '$(Build.SourcesDirectory)'
        contents: 'azure/startup.sh'
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - bash: |
        set -euo pipefail
        if [ -f "$(Build.ArtifactStagingDirectory)/startup.sh" ]; then
          chmod +x "$(Build.ArtifactStagingDirectory)/startup.sh"
        fi
        echo "Staged artifact contents:"
        ls -R "$(Build.ArtifactStagingDirectory)"
      displayName: 'Make startup.sh executable and list artifact'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish artifact: build-outputs'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'build-outputs'

- stage: CodeAnalysis
  displayName: 'SonarCloud Code Analysis'
  dependsOn: Build
  jobs:
  - job: SonarAnalysis
    displayName: 'Run SonarCloud (Gradle)'
    steps:
    - checkout: self
      fetchDepth: 0

    - task: DownloadBuildArtifacts@0
      displayName: 'Download build outputs'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'build-outputs'
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - script: |
        echo "Listing downloaded artifact:"
        ls -R "$(System.DefaultWorkingDirectory)/build-outputs"
      displayName: 'List artifact contents'

    - task: Gradle@3
      displayName: 'Gradle: sonarqube'
      inputs:
        gradleWrapperFile: 'gradlew'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        tasks: >
          :app:sonarqube
          -Dsonar.login=$(SONAR_TOKEN)
          -Dsonar.gradle.skipCompile=true
          -Dsonar.java.binaries=$(System.DefaultWorkingDirectory)/build-outputs/app/build/libs
          -Dsonar.coverage.jacoco.xmlReportPaths=$(System.DefaultWorkingDirectory)/build-outputs/app/build/reports/jacoco/test/jacocoTestReport.xml

    - script: |
        echo "SonarCloud project dashboard:"
        echo "https://sonarcloud.io/project/overview?id=X00195992_CA3"
      displayName: 'Echo SonarCloud URL'

- stage: Deploy_Test
  displayName: 'Deploy to Test Web App'
  dependsOn: CodeAnalysis
  jobs:
  - deployment: deploy_test
    displayName: 'Deploy to Azure Web App (Test)'
    environment: 'Test'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: build-outputs

          - bash: |
              set -euo pipefail
              echo "Preparing site package..."
              PACKAGE_DIR="$(Build.ArtifactStagingDirectory)/site"
              mkdir -p "$PACKAGE_DIR/app/build/libs"

              # Copy JAR from downloaded artifact into package location
              # Adjust pattern if your jar name differs
              cp "$(Pipeline.Workspace)/build-outputs/app/build/libs/"*all.jar "$PACKAGE_DIR/app/build/libs/calculator-all.jar" || {
                echo "ERROR: jar not found in downloaded artifact"; ls -R "$(Pipeline.Workspace)/build-outputs/app/build/libs"; exit 1
              }

              # Copy startup script from artifact root into package root
              if [ -f "$(Pipeline.Workspace)/build-outputs/startup.sh" ]; then
                cp "$(Pipeline.Workspace)/build-outputs/startup.sh" "$PACKAGE_DIR/startup.sh"
                chmod +x "$PACKAGE_DIR/startup.sh"
              else
                echo "WARNING: startup.sh not found in artifact; ensure it's staged in Build job"
              fi

              echo "Package contents:"
              ls -R "$PACKAGE_DIR"
            displayName: 'Prepare site package'

          - task: ArchiveFiles@2
            displayName: 'Create site zip'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/site'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/site.zip'
              replaceExistingArchive: true

          - task: AzureWebApp@1
            displayName: 'Deploy site.zip to Azure Web App (Test)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(webAppTest)'
              package: '$(Build.ArtifactStagingDirectory)/site.zip'
              appType: 'webAppLinux'
              startupCommand: 'bash startup.sh'